<%
table.init do |t|
  t.caption = 'Детализация по услуге'
  t.base_name = 'tarif_detail_results'
  t.current_id_name = 'service_category_name'
  t.pagination_per_page = 100
  t.id_name = 'service_category_name'#'service_category_tarif_class_id'
  model_keys = t.model.collect {|row| row.keys }.flatten.uniq.collect{|key| key unless [].include?(key)}.compact  
  t.heads = ['Стоимость услуги', 'Роуминг', 'Услуга', 'География услуги', 'Тип принимающего оператор','Стоимость в месяц, руб', 'Кол-во обработанных записей', 'Кол-во минут', 'Кол-во смс и ммс', 'Объем интернета, Мб']
  t.set_fields do |f| 
    if f and f['stat_results']
    	calls_volume = f['stat_results']['sum_duration_minute'].round(0) if f['stat_results']['sum_duration_minute']
    	sms_volume = f['stat_results']['count_volume'].round(0) if f['stat_results']['count_volume']
    	internet_volume = f['stat_results']['sum_volume'].round(0) if f['stat_results']['sum_volume']
    end
    
    if f and f['service_category_description']
    	rouming = f['service_category_description']['service_category_rouming_id'].uniq.join(', ')    
    	geo = f['service_category_description']['service_category_geo_id'].uniq.join(', ')    
    	partner = f['service_category_description']['service_category_partner_type_id'].uniq.join(', ')    
    	calls = f['service_category_description']['service_category_calls_id'].uniq.join(', ')    
    	fix = (f['service_category_description']['service_category_one_time_id'] + f['service_category_description']['service_category_periodic_id']).uniq.join(', ')    
    end
    
    
  	[
  	 fix,  
  	 rouming,
  	 calls,
  	 geo,
  	 partner,
  	 (f['price_value'].round(0) if f['price_value']),    
  	 (f['call_id_count'].round(0) if f['call_id_count']),    
     calls_volume,
     sms_volume,
     internet_volume,
#     f['service_category_description'],
#	 model_keys,    
  	] 
  end
end
%>
